@page "/evaluate/{ProjectId}"
@using Kritik.Shared.Models
@using Kritik.App.Services
@inject ProjectService ProjectService
@inject EvaluationService EvaluationService
@inject NavigationManager NavigationManager
@inject ToastService ToastService
@inject ValidationService ValidationService

@if (hasVoted)
{
    <div class="container mt-5 text-center">
        <div class="alert alert-warning shadow-sm rounded-4 p-5">
            <h3 class="h4 fw-bold">‚ö†Ô∏è Ya has evaluado este proyecto</h3>
            <p class="text-secondary">Solo se permite una evaluaci√≥n por proyecto.</p>
            <button class="btn btn-primary rounded-pill px-4 mt-3" @onclick="GoBack">Volver a la lista</button>
        </div>
    </div>
}
else if (project != null)
{
    <EditForm Model="@evaluation" OnValidSubmit="HandleSubmit" class="form-content container mt-4" style="max-width: 600px;">
        <DataAnnotationsValidator />
        
        <div class="text-center mb-5">
             <h2 class="tech-gradient-text">@project.TeamName</h2>
             <p class="text-secondary">@project.Description</p>
        </div>

        <div class="criterion-card bg-white p-4 rounded-4 shadow-sm mb-4">
            <div class="criterion-header d-flex justify-content-between align-items-center mb-3">
                <div class="d-flex align-items-center gap-2">
                    <span class="emoji h4 m-0">üí°</span>
                    <label class="fw-bold m-0">Innovaci√≥n</label>
                </div>
                <span class="score-badge badge bg-primary rounded-pill fs-6">@evaluation.Scores.Innovation</span>
            </div>
            <input type="range" class="form-range w-100" min="1" max="5" @bind="evaluation.Scores.Innovation" @bind:event="oninput" />
            <div class="range-labels d-flex justify-content-between text-muted small mt-2"><span>Bajo</span><span>Excelente</span></div>
        </div>

        <div class="criterion-card bg-white p-4 rounded-4 shadow-sm mb-4">
            <div class="criterion-header d-flex justify-content-between align-items-center mb-3">
                <div class="d-flex align-items-center gap-2">
                    <span class="emoji h4 m-0">üé®</span>
                    <label class="fw-bold m-0">Dise√±o y UX</label>
                </div>
                <span class="score-badge badge bg-info text-white rounded-pill fs-6">@evaluation.Scores.Usability</span>
            </div>
            <input type="range" class="form-range w-100" min="1" max="5" @bind="evaluation.Scores.Usability" @bind:event="oninput" />
            <div class="range-labels d-flex justify-content-between text-muted small mt-2"><span>Confuso</span><span>Intuitivo</span></div>
        </div>

        <div class="criterion-card bg-white p-4 rounded-4 shadow-sm mb-4">
            <div class="criterion-header d-flex justify-content-between align-items-center mb-3">
                <div class="d-flex align-items-center gap-2">
                    <span class="emoji h4 m-0">‚öôÔ∏è</span>
                    <label class="fw-bold m-0">Complejidad</label>
                </div>
                <span class="score-badge badge bg-secondary rounded-pill fs-6">@evaluation.Scores.TechnicalComplexity</span>
            </div>
            <input type="range" class="form-range w-100" min="1" max="5" @bind="evaluation.Scores.TechnicalComplexity" @bind:event="oninput" />
            <div class="range-labels d-flex justify-content-between text-muted small mt-2"><span>B√°sica</span><span>Avanzada</span></div>
        </div>

        <div class="action-area mt-5 mb-5">
            <button type="submit" class="btn-premium" disabled="@isSubmitting">
                @if (isSubmitting) { <span>Enviando...</span> } else { <span>üöÄ Enviar Evaluaci√≥n</span> }
            </button>
        </div>
    </EditForm>
}
else
{
    <div class="loader text-center mt-5"><div class="spinner-border text-primary" role="status"></div></div>
}

@code {
    [Parameter] public string ProjectId { get; set; } = null!;
    private Project? project;
    private Evaluation evaluation = new();
    private bool isSubmitting = false;
    private bool hasVoted = false;

    protected override async Task OnInitializedAsync() {
        evaluation.ProjectId = ProjectId;
        evaluation.EvaluatorId = Preferences.Default.Get("UserId", "mobile-kiosk-user");
        evaluation.Scores = new RubricScores { Innovation = 3, Usability = 3, TechnicalComplexity = 3 };
        hasVoted = await ValidationService.HasVotedAsync(ProjectId, evaluation.EvaluatorId);
        if(!hasVoted) project = await ProjectService.GetProjectByIdAsync(ProjectId);
    }
    private async Task HandleSubmit() {
        if (hasVoted) return;
        isSubmitting = true;
        var success = await EvaluationService.SubmitEvaluationAsync(evaluation);
        if (success) {
            ValidationService.RegisterVote(ProjectId);
            ToastService.Show("¬°Enviado!", "success");
            await Task.Delay(1500);
            NavigationManager.NavigateTo("/projects");
        }
        isSubmitting = false;
    }
    private void GoBack() => NavigationManager.NavigateTo("/projects");
}
