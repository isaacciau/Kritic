@page "/resultados"
@using Kritik.Shared.Models
@using Kritik.App.Services
@inject ProjectService ProjectService
@implements IDisposable

<div class="results-container">
    <div class="header-section text-center mb-4">
        <h3 class="tech-gradient-text">Ranking de Proyectos en Vivo</h3>
        <p class="stats-overview text-muted">Integridad de Datos: <span class="highlight-text">@integrityRate.ToString("P1")</span></p>
    </div>

    @if (rankedProjects == null)
    {
        <div class="loading-state text-center p-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-3 text-muted">Sincronizando métricas...</p>
        </div>
    }
    else
    {
        <div class="ranking-list">
            @foreach (var (project, index) in rankedProjects.Select((p, i) => (p, i)))
            {
                <div class="ranking-item card d-flex flex-row align-items-center mb-3 p-3 @(index == 0 ? "border-primary" : "")">
                    <div class="rank-number h4 fw-bold me-4 mb-0" style="width: 40px; color: var(--primary-color);">#@(index + 1)</div>
                    <div class="project-details flex-grow-1">
                        <h5 class="project-name mb-1 fw-bold" style="color: var(--text-dark);">@project.TeamName</h5>
                        <div class="progress" style="height: 8px; background-color: var(--border-color);">
                            <div class="progress-bar" role="progressbar" style="width: @(project.AverageScore * 10)%; background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));" aria-valuenow="@(project.AverageScore * 10)" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                    <div class="score-display ms-4 text-end">
                        <span class="avg-score h4 fw-bold mb-0" style="color: var(--text-dark);">@project.AverageScore.ToString("F1")</span>
                        <div class="small text-muted">Puntos</div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<ProjectRankingDTO>? rankedProjects;
    private double integrityRate = 0;
    private PeriodicTimer? timer;
    private CancellationTokenSource? cts;

    protected override void OnInitialized()
    {
        cts = new CancellationTokenSource();
        timer = new PeriodicTimer(TimeSpan.FromSeconds(5)); // Actualización cada 5s (User pattern adapted to PeriodicTimer)
        _ = RunPeriodicRefresh();
    }

    private async Task RunPeriodicRefresh()
    {
        try
        {
            await LoadResults();
            while (await timer!.WaitForNextTickAsync(cts!.Token))
            {
                await LoadResults();
                StateHasChanged();
            }
        }
        catch (OperationCanceledException) { }
    }

    private async Task LoadResults()
    {
        try 
        {
            var results = await ProjectService.GetRankingsAsync();
            rankedProjects = results.OrderByDescending(p => p.AverageScore).ToList();
            
            // Calculamos la tasa de integridad (User requested hardcoded example or logic)
            // Usamos el promedio de integridad del DTO si disponible, o valor fijo
            integrityRate = rankedProjects.Any() ? rankedProjects.Average(p => p.IntegrityRate) : 0.985;
        }
        catch (Exception ex) 
        {
            Console.WriteLine("Error al sincronizar resultados: " + ex.Message);
        }
    }

    public void Dispose()
    {
        cts?.Cancel();
        timer?.Dispose();
        cts?.Dispose();
    }
}
